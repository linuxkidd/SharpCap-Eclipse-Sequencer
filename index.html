<!DOCTYPE html>

<html lang=”en”>
<head>
    <title>SharpCap Eclipse Sequence Creator</title>
    <meta charset="utf-8">
    <meta name="viewport" 
          content="width=device-width, initial-scale=1.0">
</head>
<style type="text/css">
    h1 {
        color: blue;
    }

    h3 {
        text-align: left;
        padding-left: 15px;
    }

    #bodyWrapper {
        max-width: 1000px;
        margin: auto;
    }

    #FlipDivTips, #FlipDivInstructions {
        display: none;
    }

    .headerBlock {
        background-color: lightskyblue;
        margin: 0;
        padding: 15px;
        border-bottom: 1px solid blue;
    }

    .goodInput {
        border: 2px solid #0f0;
        background: rgba(0,0,0,0);
    }

    .badInput {
        border: 2px solid #f00;
        background: rgba(0,0,0,0);
    }

    .disabledInput {
        border: 1px solid #000;
        background: rgba(0,0,0,0.3);
    }

    .code {
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        background: #eee;
        padding: 1px 3px;
    }

    div {
        display: flex;
        flex-direction: column;
    }

    table {
        border-collapse: collapse;
    }

    table td {
        padding: 3px;
    }

    ul.topMenu {
        list-style-type: none;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #666;
        margin-bottom: 15px;
    }

    ul.topMenu li {
      float: left;
      border-right: 1px solid #bbb;
    }

    ul.topMenu li a {
        display: block;
        color: white;
        text-align: center;
        padding: 14px 16px;
        text-decoration: none;
    }

    ul.topMenu li a:hover {
      background-color: #111;
    }

    ul.topMenu li a.active {
        background-color: #04AA6D;
    }

    ol li {
        padding: 3px;
    }

    dl dt {
        font-weight: bold;
        font-size: 1.1em;
    }

    dl dd {
        padding: 3px;
    }

    .flipDiv {
        max-width: 80%;
    }

    .params {
        border: 1px solid;
    }

    .planDiv {
        border: 1px solid;
        margin: 10px auto;
        min-width: 1000px;
        text-align: left;
    }

    .planTable {
        width: 100%;
    }

    .planTable td {
        border-bottom: 1px solid black;
        text-align: center;
    }

    textarea {
        margin-top: 15px;
        width: 70%;
    }

    input[type="number"] {
        text-align: right;
        max-width: 60px;
    }
    input[type="text"] {
        text-align: right;
        max-width: 100px;
    }
    .wideButton {
        width: 100%;
    }
</style>
 
<body>
    <div id="bodyWrapper">
        <h1>
          SharpCap Eclipse Sequence Creator
        </h1>
        <h3>Requires <a href="https://www.sharpcap.co.uk/">SharpCap Pro</a> version 4.1.11922.0 or newer!</h3>
        <ul class="topMenu">
            <li><a id="MenuNotes" href="javascript://" onClick="toggleDiv(this);" class='active'>Notes</a></li>
            <li><a id="MenuInstructions" href="javascript://" onClick="toggleDiv(this);">Instructions</a></li>
            <li style="border-right: 0px;"><a href="javascript://" >&lt; - Click the active menu item to hide the content.</a></li>
        </ul>
        <div class="flipDiv" id="FlipDivNotes">
            <dl>
                <dt>What time?</dt>
                <dd>Times should be entered in local time of your observing site.</dd>
                <dd><b>REMEMBER</b> - Times will shift earlier by 1 hour for most due to the upcoming Daylight Savings Time change.</dd>
                <dd>You can get the local Eclilpse Event Times from <a href="https://www.timeanddate.com/eclipse/map/2024-april-8" target="_blank">Time and Date</a>.</dd>
                <dt>Lots of Data...</dt>
                <dd>I suggest adding <span class="code">{TargetName}</span> and <span class="code">{Exposure}</span> in the filename template in SharpCap Settings to make it easier to differentiate files after the eclipse.</dd>
                <dd>Example: <span class="code">{Date:S}\{TargetName}\{TargetName}_{Time}_{Exposure}</span></dd>
                <dt>Test, test test!</dt>
                <dd>Ahead of the eclipse, please test the operation and behavior of your hardware.</dd>
                <dt>Total Recall</dt>
                <dd>The full configuration is now saved to your local browser, in case you'd like to tweak your action plan in the future.</dd>
                <dd>The parameter encoded URL is put as a comment in the top of the generated sequence file, so you can use that for future collection plan tweaks.</dd>
                <dt>Baily's Beads into Totality</dt>
                <dd>If you'd like to capture the Baily's Beads Collection Plan into totality, you can do so by fudging the 'Full Begins' and/or 'Full Ends' times to be after totality begins/before totality ends.</dd>
                <dd>This may be useful since prediction of the exact moment of totality is not exact due to the shape of the Moon's surface.</dd>
            </dl>
        </div>
        <div class="flipDiv" id="FlipDivInstructions">
            <ol>
                <li>Go to <a href="https://www.timeanddate.com/eclipse/map/2024-april-8" target="_blank">Eclipse Map</a>.</li>
                <li>Zoom into your observation location and click to place the pin on the map.</li>
                <li>Note the <i>Partial</i> and <i>Full</i> <i>Begin</i> and <i>End</i> times provided on the left side of the map.</li>
                <li>Enter the observing site local times under <span class="code">Eclipse Times</span> below, in 24 hour, HH:MM:SS format.</li>
                <li>Adjust the <span class="code">Intervals</span> and <span class="code">Camera Settings</span> as desired below.<br />
                    <b>Notes:</b>
                    <ul>
                        <li><span class="code">Partial Eclipse Count</span> <b>(recommended)</b> generates evenly spaced collections based on partial eclipse percentage, starting 1 minutes into the eclipse.</li>
                        <li><span class="code">Partial Eclipse Interval</span> generates evenly space collections based on time alone, with no concern for even partial percentage.</li>
                        <li><b>The two cannot be used at the same time.</b></li>
                    </ul>
                </li>
                <li>Add and adjust the steps for each <span class="code">Collection Plan</span> section below.</li>
                <li>Click the <span class="code">Generate</span> button.</li>
                <li>A <span class="code">Generated Sequence</span> section will appear below.</li>
                <li>Use the <span class="code">Download SharpCap Sequence</span> button and save the sequence file.</li>
                <li>In SharpCap Pro version 4.1.11922.0 or newer:
                    <ul type="a">
                        <li>Connect to your camera and center the Sun in your camera's view.</li>
                        <li>Click the <span class="code">Sequencer</span> menu item</li>
                        <li>Then <span class="code">Run...</span></li>
                        <li>Pick the downloaded sequence file and click the <span class="code">Open</span> button.</li>
                    </ul>
                </li>
                <li>Monitor for an Alert sound, and banner at the top to Remove or Apply the Solar Filter around the time of Totality.</li>
            </ol>
        </div>
        <table id="wrapperTable"><tr style="vertical-align: top;"><td>
            <table class="params">
                <tr><th colspan="2" class="headerBlock">Eclipse Times</th></tr>

                <tr><td class="label">(C1) Partial Begins:</td><td><input onChange="verifyTime(this);" onKeyUp="verifyTime(this);" id="partial_begins" type="text"></td></tr>
                <tr><td class="label">(C2) Full Begins:</td><td><input onChange="verifyTime(this);" onKeyUp="verifyTime(this);" id='full_begins' type="text"></td></tr>
                <tr><td class="label">(C3) Full Ends:</td><td><input onChange="verifyTime(this);" onKeyUp="verifyTime(this);" id='full_ends' type="text"></td></tr>
                <tr><td class="label">(C4) Partial Ends:</td><td><input onChange="verifyTime(this);" onKeyUp="verifyTime(this);" id="partial_ends" type="text"></td></tr>
            </table></td><td>
                <table class="params" id="phaseInterval">
                    <th colspan="2" class="headerBlock">Collection Timing</th>
                    <tr><td class="label">Partial Eclipse Count:</td><td>
                        <select id='partialCount' onChange="checkVisible('partialCount');">
                            <option value="0">Disabled</option>
                            <option value="5">5 times</option>
                            <option value="10" selected="selected">10 times</option>
                            <option value="20">20 times</option>
                            <option value="40">40 times</option>
                            <option value="50">50 times</option>
                            <option value="100">100 times</option>
                        </select> before and after
                    </td></tr>
                    <tr><td class="label">Partial Eclipse Interval:</td><td>
                        <select id='partialInterval' onChange="checkVisible('partialInterval');">
                            <option value="0">Disabled</option>
                            <option value="30">every 30 seconds</option>
                            <option value="60">every 1 minute</option>
                            <option value="120">every 2 minutes</option>
                            <option value="180">every 3 minutes</option>
                            <option value="240">every 4 minutes</option>
                            <option value="300">every 5 minutes</option>
                            <option value="360">every 6 minutes</option>
                            <option value="420">every 7 minutes</option>
                            <option value="480">every 8 minutes</option>
                            <option value="540">every 9 minutes</option>
                            <option value="600">every 10 minute</option>
                        </select>
                    </td></tr>
                    <tr><td class="label">Baily's Beads Capture Offset:</td><td>
                        <select id='bailysInterval' onChange="checkVisible('bailysInterval');">
                            <option value="0">Disabled</option>
                            <option value="6">+/- 6 seconds</option>
                            <option value="8">+/- 8 seconds</option>
                            <option value="10">+/- 10 seconds</option>
                            <option value="20">+/- 20 seconds</option>
                            <option value="30" selected="selected">+/- 30 seconds</option>
                            <option value="45">+/- 45 seconds</option>
                            <option value="60">+/- 60 seconds</option>
                        </select><input type='hidden' id='totalityInterval' value='1'/>
                    </td></tr>
                    <!-- <tr><td class="label">Totality Interval:</td><td>as fast as possible</td></tr> -->
                </table>
            </td><td>
            <table class="params">
                <th colspan="2" class="headerBlock">Camera Settings</th>
                <tr><td class="label">Camera Gain:</td><td><input onChange="hideOutput();" type="number" id="gain" value="26" min="0"/></td></tr>
                <tr><td class="label">Camera Offset:</td><td><input onChange="hideOutput();" type="number" id="offset" value="70" min="0"/></td></tr>
                <tr><td class="label">Output Format:</td><td>
                    <select id="output" onChange="hideOutput();">
                        <option value="SER file (*.ser)">SER</option>
                        <option value="PNG files (*.png)">PNG</option>
                        <option value="FITS files (*.fits)">FITS</option>
                        <option value="TIFF files (*.tif)">TIFF</option>
                        <option value="ADV files (*.adv)">ADV</option>
                    </select></td></tr>
            </table>
        </th></tr></table>
        <div class="planDiv" id="partialPlanDiv"><h3 class="headerBlock">Partial Phase Collection Plan :: repeat <span id="partialPlanHeader"></span> before and after Totality.</h3><table class="planTable" id="partialPlan"></table><input type='button' class="wideButton" value="Add Partial Plan Row" onClick='addPlanLine("partialPlan")' /></div>
        <div class="planDiv" id="bailysPlanDiv"><h3 class="headerBlock">Baily's Beads Collection Plan :: repeat every <input id="bailysDelay" onChange="hideOutput();" type="number" value="0" min="0"/> seconds for <span id="bailysPlanHeader"></span> on either side of Totality.</h3><table class="planTable" id="bailysPlan"></table><input type='button' class="wideButton" value="Add Bailys Plan Row" onClick='addPlanLine("bailysPlan")' /></div>
        <div class="planDiv" id="totalityPlanDiv"><h3 class="headerBlock">Totality Collection Plan :: repeat repeat every <input id="totalityDelay" onChange="hideOutput();" type="number" value="0" min="0"/> seconds during Totality.</h3><table class="planTable" id="totalityPlan"></table><input type='button' class="wideButton" value="Add Totality Plan Row" onClick='addPlanLine("totalityPlan")' /></div>
        <input type="button" style="max-width: 45%; margin: 30px auto; padding: 30px;" value="Generate Sequence" id="generateButton" onClick="generateSharpCap();"/>

        <div class="planDiv" id="sequenceDiv" style="display: none;">
            <h3 class="headerBlock">Generated Sequence</h3>
            <input type="button" value="Copy Sequence to Clipboard" id="clipboardButton" style="margin: 15px 15px 0 15px; max-width: 45%;" onClick="copyToClipboard();" /><input type="button" value="Download SharpCap Sequence" id="downloadButton" style="max-width: 45%;" onClick="downloadSequence();" />
            <textarea id="SharpCapSequence" style="width: 98%; height: 200px;" readonly="readonly"
            placeholder="SharpCap sequence will appear here."></textarea>
        </div>
    </div>
    <script type="text/javascript">
        function uuidv4() {
            return "10000000-1000-4000-8000-100000000000".replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }

        function ucFirst(word) {
            return word.charAt(0).toUpperCase() + word.slice(1);
        }

        function toggleDiv(t) {
            let divs=document.querySelectorAll('[id^="FlipDiv"]');
            let menus=document.querySelectorAll('[id^="Menu"]');
            if(t.classList.contains("active")) {
                divs.forEach(async (d) => {
                    d.style.display = "none";
                });
                menus.forEach(async (m) => { 
                    m.classList.remove("active");
                });
                return;
            }
            divs.forEach(async (d) => {
                if(d.id!="FlipDiv"+t.innerHTML) {
                    d.style.display = "none";
                }
            });
            menus.forEach(async (m) => { 
                if(m.id!="Menu"+t.innerHTML) {
                    m.classList.remove("active");
                }
            });
            t.classList.add("active");
            document.getElementById("FlipDiv"+t.innerHTML).style.display = "block";
        }

        function checkVisible(t) {
            let pmap = { "partialCount": "partialInterval", "partialInterval": "partialCount" };
            let e = document.getElementById(t);
            t = t.replace(/[A-Z].*$/,"");
            try {
                if(e.value==0) {
                    if(t.match("partial")) {
                        let pi=document.getElementById("partialInterval").value;
                        let pc=document.getElementById("partialCount").value;
                        if(pi==0 && pc==0) {
                            document.getElementById(t+"PlanDiv").style.display="none";
                            document.getElementById("partial_begins").classList.remove("goodInput");
                            document.getElementById("partial_begins").classList.remove("badInput");
                            document.getElementById("partial_begins").classList.add("disabledInput");
                            document.getElementById("partial_begins").readonly="readonly";
                            document.getElementById("partial_ends").classList.remove("goodInput");
                            document.getElementById("partial_ends").classList.remove("badInput");
                            document.getElementById("partial_ends").classList.add("disabledInput");
                            document.getElementById("partial_ends").readonly="readonly";
                        } else {
                            document.getElementById(t+"PlanDiv").style.display="block";
                            document.getElementById(t+"PlanHeader").innerHTML = e.options[e.selectedIndex].innerHTML;
                            if(document.getElementById(t+"Plan").rows.length==0)
                                addPlanLine(t+"Plan");
                            document.getElementById("partial_begins").removeAttribute('readonly');
                            document.getElementById("partial_ends").removeAttribute('readonly');
                            verifyTime(document.getElementById("partial_begins"));
                            verifyTime(document.getElementById("partial_ends"));
                        }
                    } else {
                        document.getElementById(t+"PlanDiv").style.display="none";
                    }
                } else {
                    var phPost = "";
                    if(t.match("partial"))
                        document.getElementById(pmap[e.id]).value = 0;
                    document.getElementById(t+"PlanDiv").style.display="block";
                    document.getElementById(t+"PlanHeader").innerHTML = e.options[e.selectedIndex].innerHTML + phPost;
                    if(document.getElementById(t+"Plan").rows.length==0)
                        addPlanLine(t+"Plan");
                    if(t=="partial") {
                        document.getElementById("partial_begins").removeAttribute('readonly');
                        document.getElementById("partial_ends").removeAttribute('readonly');
                        verifyTime(document.getElementById("partial_begins"));
                        verifyTime(document.getElementById("partial_ends"));
                    }
                }
            } catch(err) {
                console.log("Err: "+t+" :: "+err);
            }
            hideOutput();
        }

        function hideOutput() {
            document.getElementById("sequenceDiv").style.display = "none";
            saveState();
        }

        function verifyTime(t) {
            hideOutput();
            let v=/^([0-1]?[0-9]|2[0-3]):([0-5][0-9])(:[0-5][0-9])$/.test(t.value);
            if(v) {
                t.classList.add("goodInput");
                t.classList.remove("badInput");
                t.classList.remove("disabledInput");
                saveState();
            } else {
                t.classList.remove("goodInput");
                t.classList.add("badInput");
                t.classList.remove("disabledInput");
            }
        }

        function checkIfLastStep(t) {
            let tbl = document.getElementById(t);
            if(tbl.rows.length==1)
                tbl.rows[0].cells[4].style.display="none";
            else
                tbl.rows[0].cells[4].style.display="block";
                hideOutput();
        }

        function addPlanLine(t) {
            let rowID = uuidv4();
            let tbl = document.getElementById(t);
            let rows = tbl.rows.length;
            let row = tbl.insertRow(tbl.rows.length);
            var cells = [];
            for(var i=0; i<5; i++)
                cells.push(row.insertCell(i));
            cells[0].innerHTML = "<input type='hidden' name='uuid' value='"+rowID+"' /><span name='step'>Step "+(rows+1).toString()+"</span>";
            cells[0].style.fontWeight = "bold";
            cells[0].style.textAlign = "center";
            cells[1].innerHTML = "Capture <input type='number' id='"+rowID+"count' value='1' min='1' onChange='hideOutput();' /><select onChange='hideOutput();' id='"+rowID+"type'><option value='frames' selected='selected'>frames</option><option value='seconds'>seconds</option></select>";
            cells[2].innerHTML = "at Exposure: <input type='number' id='"+rowID+"exposure' value='0.01' min='0' onChange='hideOutput();' /> sec";
            cells[3].innerHTML = "at Resolution: <input type='text' id='"+rowID+"resolution' value='' onChange='hideOutput();' /> pixels (blank = no change)";
            cells[4].innerHTML = "<input type='button' value='Delete Step' onClick='removeRow(this)' />"
            checkIfLastStep(t);
        }

        function removeRow(t) {
            let p = t.parentNode.parentNode;
            let tbl = document.getElementById(p.parentNode.parentNode.id);
            if(tbl.rows.length==1) {
                alert("Collection Plan needs at least one step.  Cannot delete the last step.");
                return;
            }
            p.parentNode.removeChild(p);

            for(var i=0;i<tbl.rows.length;i++) {
                tbl.rows[0].cells[0].childNodes[1].innerHTML = "Step "+(i+1).toString();
            }
            checkIfLastStep(tbl.id);
        }

        function format02d(v) {
            return(("00"+v.toString()).substr(-2))
        }

        function timeToSeconds(tm) {
            let tp = tm.split(":");
            var secs = parseInt(tp[2]);
            secs += parseInt(tp[1])*60;
            secs += parseInt(tp[0])*3600;
            return secs;
        }

        function secondsToTime(secs) {
            let h = Math.floor(secs/3600);
            secs -= h*3600;
            let m = Math.floor(secs/60);
            secs -= m*60;
            return(format02d(h)+":"+format02d(m)+":"+format02d(secs))
        }

        function generateSharpCap() {
            var now = new Date();
            var preOutput = new Array(
                "SEQUENCE",
                "    # Generated by: ",
                "    # linuxkidd's SharpCap Eclipse Sequencer",
                "    # "+(window.location.href+"#"+dumpParams(hashMode=1)).replace(/##/g,"#")+";plans="+JSON.stringify(dumpPlans()),
                "    #",
                "    # Generated at: ",
                "    # "+now.toDateString()+" "+now.toTimeString(),
                "    #",
                "    #",
                "    # (C1) Partial begins: "+document.getElementById("partial_begins").value,
                "    # (C2) Full begins:    "+document.getElementById("full_begins").value,
                "    # (C3) Full ends:      "+document.getElementById("full_ends").value,
                "    # (C4) Partial ends:   "+document.getElementById("partial_ends").value,
                "    #"
                );
            ["bailysInterval","partialCount","partialInterval","gain","offset","output"].forEach((a) => {
                preOutput.push("    # "+a+": "+document.getElementById(a).value);
            });
            preOutput.push("    #","    #");
            var output = new Array();
            var indent = 4;
            let partialInterval = parseInt(document.getElementById("partialInterval").value);
            let partialCount = parseInt(document.getElementById("partialCount").value);
            let bailysInterval = parseInt(document.getElementById("bailysInterval").value);
            let totalityDuration = timeToSeconds(document.getElementById("full_ends").value) - timeToSeconds(document.getElementById("full_begins").value);
            var preInterval = partialInterval;
            var postInterval = partialInterval;
            if(partialCount>0) {
                let preDuration = timeToSeconds(document.getElementById("full_begins").value) - timeToSeconds(document.getElementById("partial_begins").value) - bailysInterval - 120;
                let postDuration = timeToSeconds(document.getElementById("partial_ends").value) - timeToSeconds(document.getElementById("full_ends").value) - bailysInterval - 120;
                preInterval = preDuration / partialCount;
                postInterval = postDuration / partialCount;
            }

            try {
                if(partialInterval>0 || partialCount>0) {
                    ["partial_begins", "partial_ends"].forEach((t) => {
                        let v = /^([0-1]?[0-9]|2[0-3]):([0-5][0-9])(:[0-5][0-9])$/.test(document.getElementById(t).value);
                        if(document.getElementById(t).value=="" || !v) {
                            alert("  Sorry, please fill in the "+t.split("_").join(" ")+" timestamp\n    in 24 hour, HH:MM:SS format.");
                            throw BreakException;
                        }
                    });
                }
                ["full_begins", "full_ends"].forEach((t) => {
                    let v = /^([0-1]?[0-9]|2[0-3]):([0-5][0-9])(:[0-5][0-9])$/.test(document.getElementById(t).value);
                    if(document.getElementById(t).value=="" || !v) {
                        alert("  Sorry, please fill in the "+t.split("_").join(" ")+" timestamp\n    in 24 hour, HH:MM:SS format.");
                        throw BreakException;
                    }
                });
            } catch(e) {
                return;
            }

            ["partialInterval", "partialCount", "bailysInterval", "totalityInterval"].forEach((p) => {
                let e = document.getElementById(p);
                if(e.value!=0) {
                    p = p.replace(/[A-Z].*$/,"");
                    output.push(' '.repeat(indent)+"DEF SUB "+p+"Collection");
                    indent+=4;
                    preOutput.push("    # "+"#".repeat(36),"    # "+p+"Collection Plan","    # "+"#".repeat(36));
                    let t = document.getElementById(p+"Plan");
                    var lastRes = "";
                    var rowPseudo = "";
                    for( var row=0; row<t.rows.length; row++ ) {
                        let rowID = t.rows[row].cells[0].childNodes[0].value;
                        rowPseudo = "Step: "+(row+1).toString()+" - Capture "+document.getElementById(rowID+"count").value+" "+document.getElementById(rowID+"type").value;
                        rowPseudo += " at Exposure "+document.getElementById(rowID+"exposure").value + " seconds";
                        output.push(' '.repeat(indent)+"SET EXPOSURE TO "+document.getElementById(rowID+"exposure").value);
                        if(document.getElementById(rowID+"resolution").value!="" && document.getElementById(rowID+"resolution").value!=lastRes) {
                            output.push(' '.repeat(indent)+"SET RESOLUTION TO "+document.getElementById(rowID+"resolution").value);
                            rowPseudo += " at Resollution "+document.getElementById(rowID+"resolution").value;
                        }
                        var secVerb = "";
                        if(document.getElementById(rowID+"type").value=="seconds")
                            secVerb = " SECONDS ";
                        if(row>0) {
                            var delaySecs = Math.min(document.getElementById(rowID+"exposure").value * 5,2);
                            output.push(' '.repeat(indent)+"DELAY "+delaySecs.toString());
                            preOutput.push("    # Wait for "+delaySecs.toString()+" seconds");
                        }
                        output.push(' '.repeat(indent)+"CAPTURE "+document.getElementById(rowID+"count").value+secVerb+" LIVE FRAMES");
                        lastRes=document.getElementById(rowID+"resolution").value;
                        preOutput.push("    # "+rowPseudo);
                    }
                    preOutput.push("    #","    #");
                    indent-=4;
                    output.push(' '.repeat(indent)+"END SUB")
                    output.push("");
                }
            });

            function addWaitSub(title,startTime,offsetTime) {
                output.push(' '.repeat(indent)+"DEF SUB waitFor"+title)
                indent+=4;
                let st = secondsToTime(timeToSeconds(startTime)+offsetTime);
                output.push(' '.repeat(indent)+"WAIT UNTIL LATER THAN LOCALTIME "+st);
                indent-=4;
                output.push(' '.repeat(indent)+"END SUB")
                output.push("");
            }

            function addCollection(subRoutine,endTime,duration) {
                output.push(' '.repeat(indent)+"STOP AT LOCALTIME "+endTime);
                indent+=4;
                output.push(' '.repeat(indent)+"LOOP UNTIL LATER THAN LOCALTIME "+endTime);
                indent+=4;
                if(duration>0) {
                    output.push(' '.repeat(indent)+"PAD DURATION TO "+duration.toString());
                    indent+=4;
                }
                output.push(' '.repeat(indent)+"GOSUB "+subRoutine);

                if(duration>0) {
                    indent-=4;
                    output.push(' '.repeat(indent)+"END PAD DURATION");
                }
                indent-=4;
                output.push(' '.repeat(indent)+"END LOOP");
                indent-=4;
                output.push(' '.repeat(indent)+"END STOP AT");
                output.push("");
            }

            var esOffset=0;
            if(partialInterval>0 || partialCount>0 ) {
                addWaitSub('PreEclipseStart',document.getElementById('partial_begins').value,-60);
                if(partialCount > 0)
                    esOffset=60;
                addWaitSub('EclipseStart',document.getElementById('partial_begins').value,esOffset);

                addWaitSub('PostTotalityPartialStart',document.getElementById('full_ends').value,bailysInterval + 60);
                addWaitSub('EclipseEnd',document.getElementById('partial_ends').value,esOffset * -1);
                addWaitSub('PostEclipseEnd',document.getElementById('partial_ends').value,60);
            }
            if(bailysInterval>0)
                addWaitSub('BailysOneStart',document.getElementById('full_begins').value,bailysInterval*-1);

            addWaitSub('TotalityStart',document.getElementById('full_begins').value,0);
            output.push(`    PRESERVE CAMERA SETTINGS`);
            output.push(`        UNLOCK CONTROLS`);
            output.push("");
            indent=12;

            output.push(' '.repeat(indent)+"LIVE MODE");
            output.push(' '.repeat(indent)+'ARRANGE FILES IN ONE FOLDER');
            output.push(' '.repeat(indent)+'TARGETNAME "PartialPreEclipse"');
            output.push(' '.repeat(indent)+"SET GAIN TO "+document.getElementById("gain").value);
            output.push(' '.repeat(indent)+"SET OFFSET to "+document.getElementById("offset").value);
            output.push(' '.repeat(indent)+'SET OUTPUT FORMAT TO "'+document.getElementById("output").value+'"');
            output.push("");

            preOutput.push("    #","    # ## Begin Sequence","    #");
            var esOffset = 0;
            if(partialInterval>0 || partialCount>0) {
                if(partialCount > 0) {
                    esOffset = 60;
                    preOutput.push("    # Wait until "+secondsToTime(timeToSeconds(document.getElementById('partial_begins').value)-esOffset));
                    preOutput.push("    # Capture one iteration of 'partialCollection'");

                    output.push(' '.repeat(indent)+"GOSUB waitForPreEclipseStart");
                    stopTime = secondsToTime(timeToSeconds(document.getElementById('partial_begins').value)+esOffset-1);
                    output.push(' '.repeat(indent)+"STOP AT LOCALTIME "+stopTime);
                    indent+=4;
                    output.push(' '.repeat(indent)+"LOOP UNTIL LATER THAN LOCALTIME "+stopTime);
                    indent+=4;
                    output.push(' '.repeat(indent)+"PAD DURATION TO "+(esOffset*2).toString());
                    indent+=4;
                    output.push(' '.repeat(indent)+"GOSUB partialCollection");
                    indent-=4;
                    output.push(' '.repeat(indent)+"END PAD DURATION");
                    indent-=4;
                    output.push(' '.repeat(indent)+"END LOOP");
                    indent-=4;
                    output.push(' '.repeat(indent)+"END STOP AT");
                    output.push("")
                }
                preOutput.push("    #","    # Wait until "+secondsToTime(timeToSeconds(document.getElementById('partial_begins').value)+esOffset));
                output.push(' '.repeat(indent)+"GOSUB waitForEclipseStart");
                var stopTime = secondsToTime(timeToSeconds(document.getElementById('full_begins').value) - bailysInterval - 60); // Add in 60 second buffer before next step
                preOutput.push("    # Collect 'partialCollection' every "+preInterval+" seconds, until "+stopTime);
                addCollection("partialCollection",stopTime,preInterval);
            }
            if(bailysInterval>0) {
                preOutput.push("    #","    # Wait until "+secondsToTime(timeToSeconds(document.getElementById('full_begins').value)-bailysInterval));
                output.push(' '.repeat(indent)+"GOSUB waitForBailysOneStart");
                output.push(' '.repeat(indent)+'TARGETNAME "BailysBeadsPreEclipse"');
                output.push(' '.repeat(indent)+"PLAY SOUND Alert");
                output.push(' '.repeat(indent)+'SHOW NOTIFICATION "Remove the Solar Filter!" COLOUR Green DURATION '+(totalityDuration+bailysInterval).toString());
                preOutput.push("    # Collect 'bailysCollection' every "+document.getElementById("bailysDelay").value+" seconds, until "+document.getElementById('full_begins').value);
                addCollection("bailysCollection",document.getElementById('full_begins').value,document.getElementById("bailysDelay").value);
            }

            preOutput.push("    #","    # Wait until "+document.getElementById('full_begins').value);
            output.push(' '.repeat(indent)+"GOSUB waitForTotalityStart");
            if(partialInterval==0 && partialCount==0 && bailysInterval==0) {
                output.push(' '.repeat(indent)+"PLAY SOUND Alert");
                output.push(' '.repeat(indent)+'SHOW NOTIFICATION "Remove the Solar Filter!" COLOUR Green DURATION '+totalityDuration.toString());
            }
            output.push(' '.repeat(indent)+'TARGETNAME "FullEclipse"');
            preOutput.push("    # Collect 'totalityCollection' every "+document.getElementById("totalityDelay").value+" seconds, until "+document.getElementById('full_ends').value);
            addCollection("totalityCollection",document.getElementById("full_ends").value,document.getElementById("totalityDelay").value);

            if(bailysInterval>0) {
                preOutput.push("    #","    # Collect 'bailysCollection' every "+document.getElementById("bailysDelay").value+" seconds, until "+secondsToTime(timeToSeconds(document.getElementById('full_ends').value)+bailysInterval));
                output.push(' '.repeat(indent)+'TARGETNAME "BailysBeadsPostEclipse"');
                var stopTime = secondsToTime(timeToSeconds(document.getElementById('full_ends').value)+bailysInterval);
                addCollection("bailysCollection",stopTime,document.getElementById("bailysDelay").value);
            }
            output.push(' '.repeat(indent)+"PLAY SOUND Error");
            output.push(' '.repeat(indent)+'SHOW NOTIFICATION "URGENT!   Apply the Solar Filter!   URGNET!" COLOUR Red DURATION 120');
            output.push("");

            if(partialInterval>0 || partialCount>0) {
                preOutput.push("    #","    # Wait until "+ secondsToTime(timeToSeconds(document.getElementById('full_ends').value) + bailysInterval + 60));
                output.push(' '.repeat(indent)+'GOSUB waitForPostTotalityPartialStart');
                output.push(' '.repeat(indent)+'TARGETNAME "PartialPostEclipse"');
                preOutput.push("    # Collect 'partialCollection' every "+postInterval+" seconds, until "+secondsToTime(timeToSeconds(document.getElementById('partial_ends').value) - esOffset));
                addCollection("partialCollection",secondsToTime(timeToSeconds(document.getElementById('partial_ends').value)-esOffset),postInterval);

                if(partialCount > 0) {
                    esOffset = 60;
                    preOutput.push("    #","    # Wait until "+ secondsToTime(timeToSeconds(document.getElementById('partial_ends').value) + esOffset));
                    preOutput.push("    # Capture one iteration of 'partialCollection'");
                    output.push(' '.repeat(indent)+"GOSUB waitForPostEclipseEnd");

                    stopTime = secondsToTime(timeToSeconds(document.getElementById('partial_ends').value)+esOffset);
                    output.push(' '.repeat(indent)+"STOP AT LOCALTIME "+stopTime);
                    indent+=4;
                    output.push(' '.repeat(indent)+"LOOP UNTIL LATER THAN LOCALTIME "+stopTime);
                    indent+=4;
                    output.push(' '.repeat(indent)+"PAD DURATION TO "+(esOffset*2).toString());
                    indent+=4;
                    output.push(' '.repeat(indent)+"GOSUB partialCollection");
                    indent-=4;
                    output.push(' '.repeat(indent)+"END PAD DURATION");
                    indent-=4;
                    output.push(' '.repeat(indent)+"END LOOP");
                    indent-=4;
                    output.push(' '.repeat(indent)+"END STOP AT");
                    output.push("")
                }
            }
            output.push(' '.repeat(indent)+"PLAY SOUND Alert");
            output.push(' '.repeat(indent)+'SHOW NOTIFICATION "Solar Eclipse Collection is complete!" COLOUR Green DURATION 120');

            output.push(`        END UNLOCK`);
            output.push(`    END PRESERVE`);
            output.push("END SEQUENCE");
            preOutput.push("    #","    # ## End Sequence","    #","    #");

            document.getElementById("SharpCapSequence").value = preOutput.join("\n") + "\n\n" + output.join("\n");
            document.getElementById("sequenceDiv").style.display = "block";
            window.scrollTo(0, document.body.scrollHeight);
        }

        function copyToClipboard() {
            navigator.clipboard.writeText(document.getElementById("SharpCapSequence").value);
        }

        function downloadSequence() {
            var textToSave = document.getElementById("SharpCapSequence").value;
            var textToSaveAsBlob = new Blob([textToSave], {type:"text/plain"});
            var textToSaveAsURL = window.URL.createObjectURL(textToSaveAsBlob);
            var fileNameToSaveAs = "SharpCap_Eclipse_Sequence.scs";

            var downloadLink = document.createElement("a");
            downloadLink.download = fileNameToSaveAs;
            downloadLink.innerHTML = "Download File";
            downloadLink.href = textToSaveAsURL;
            downloadLink.onclick = destroyClickedElement;
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);

            downloadLink.click();
        }

        function destroyClickedElement(event) {
            document.body.removeChild(event.target);
        }


        function parseSavedParams(params) {
            for( const [k,v] of Object.entries(params) ) {
                try {
                    document.getElementById(k).value = v;
                } catch(e) {
                    // pass;
                }
            }
        }


        function parseSavedPlans(plans) {
            for( const [p,rows] of Object.entries(plans) ) {
                let t = document.getElementById(p+"Plan");
                if(t) {
                    for(var r = t.rows.length; r<rows.length; r++)
                        addPlanLine(p+"Plan");

                    for(var row=0; row<rows.length; row++) {
                        let rowID = t.rows[row].cells[0].childNodes[0].value;
                        document.getElementById(rowID+"count").value    = rows[row][0];
                        document.getElementById(rowID+"type").value     = rows[row][1];
                        document.getElementById(rowID+"exposure").value = rows[row][2];
                        if(rows[row].length==4)
                            document.getElementById(rowID+"resolution").value = rows[row][3];
                    }
                }
            }
        }

        function readURL() {
            let kvs = window.location.hash.replace("#","").split(";");
            kvs.forEach((a) => {
                if(a.length == 0)
                    return;
                let kv=decodeURI(a).split("=");
                if(kv[0]=="plans") {
                    parseSavedPlans(JSON.parse(kv[1]));
                } else {
                    try {
                        document.getElementById(kv[0]).value = kv[1];
                    } catch(e) {
                        // pass;
                    }
                }
            });
            window.location.hash='';
        }

        function dumpPlans() {
            var plans={};
            ["partialInterval", "partialCount", "bailysInterval", "totalityInterval"].forEach((p) => {
                let e = document.getElementById(p);
                if(e.value!=0) {
                    p = p.replace(/[A-Z].*$/,"");
                    plans[p]=new Array();
                    let t = document.getElementById(p+"Plan");
                    for( var row=0; row<t.rows.length; row++ ) {
                        let rowID = t.rows[row].cells[0].childNodes[0].value;
                        plans[p].push([
                            parseFloat(document.getElementById(rowID+"count").value),
                            document.getElementById(rowID+"type").value,
                            parseFloat(document.getElementById(rowID+"exposure").value)]);
                        if(document.getElementById(rowID+"resolution").value!="")
                            plans[p][plans[p].length - 1].push(document.getElementById(rowID+"resolution").value);
                    }
                }
            });
            return plans;
        }

        function dumpParams(hashMode=0) {
            if(hashMode)
                var params = [];
            else
                var params = {};

            ["partial_begins", "partial_ends","full_begins", "full_ends","bailysInterval","partialInterval", "partialCount","gain","offset","output","bailysDelay","totalityDelay"].forEach((a) => {
                params[a]=document.getElementById(a).value;
                if(hashMode) {
                        params.push(a+'='+document.getElementById(a).value)
                } else {
                    if(document.getElementById(a).value.match(/^[0-9\.\-]+$/))
                        params[a]=parseFloat(document.getElementById(a).value);
                    else
                        params[a]=document.getElementById(a).value;
                }
            });
            if(hashMode)
                return params.join(";");
            return params;
        }

        function saveState() {
            window.localStorage.setItem("params",JSON.stringify(dumpParams()));
            window.localStorage.setItem( "plans",JSON.stringify(dumpPlans()));
        }

        function loadState() {
            let ls=window.localStorage;
            if(ls.hasOwnProperty('params'))
                parseSavedParams(JSON.parse(ls.getItem('params')));
            if(ls.hasOwnProperty('plans'))
                parseSavedPlans(JSON.parse(ls.getItem('plans')));
        }

        readURL();
        loadState();

        if(document.getElementById("totalityPlan").rows.length==0)
            addPlanLine("totalityPlan");
        checkVisible("partialInterval");
        checkVisible("partialCount");
        checkVisible("bailysInterval");
        setTimeout(function() {["partial_begins","full_begins","full_ends","partial_ends"].forEach((t) => verifyTime(document.getElementById(t)));},500);
        
    </script>
</body>
 
</html>