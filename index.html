<!DOCTYPE html>

<html lang=”en”>
<head>
    <title>SharpCap Eclipse Sequence Creator</title>
    <meta charset="utf-8">
    <meta name="viewport" 
          content="width=device-width, initial-scale=1.0">
</head>
<style type="text/css">
    h3 {
        text-align: left;
        padding-left: 15px;
    }

    #bodyWrapper {
        max-width: 1000px;
        margin: auto;
    }

    #tipsDiv, #instructionsDiv {
        display: none;
    }

    .headerBlock {
        background-color: lightskyblue;
        margin: 0;
        padding: 15px;
        border-bottom: 1px solid blue;
    }

    .goodInput {
        border: 2px solid #0f0;
        background: rgba(0,0,0,0);
    }

    .badInput {
        border: 2px solid #f00;
        background: rgba(0,0,0,0);
    }

    .disabledInput {
        border: 1px solid #000;
        background: rgba(0,0,0,0.3);
    }

    div {
        display: flex;
        flex-direction: column;
    }

    table {
        border-collapse: collapse;
    }

    table td {
        padding: 3px;
    }

    .params {
        border: 1px solid;
    }

    .planDiv {
        border: 1px solid;
        margin: 10px auto;
        min-width: 1000px;
        text-align: left;
    }

    .planTable {
        width: 100%;
    }

    .planTable td {
        border-bottom: 1px solid black;
        text-align: center;
    }

    textarea {
        margin-top: 15px;
        width: 70%;
    }

    input[type="number"] {
        text-align: right;
        max-width: 60px;
    }
    input[type="text"] {
        text-align: right;
        max-width: 100px;
    }
    .wideButton {
        width: 100%;
    }
</style>
 
<body>
    <div id="bodyWrapper">
        <h1 style="color: blue;">
          SharpCap Eclipse Sequence Creator
        </h1>
        <a id="notesToggle" href="javascript://" onClick="toggleDiv('notes');" style="margin: 15px;">( Hide Notes )</a>
        <div id="notesDiv">
            <span style="font-weight: bold;">Notes:</span>
            <ul>
                <li><b>Requires <a href="https://www.sharpcap.co.uk/">SharpCap Pro</a> version 4.1.11922.0 or newer!</b>.</li>
                <li>Times should be entered in local time of your observing site - REMEMBER - Times will shift 1 hour for most due to the upcoming Daylight Savings Time change.</li>
                <li>Due to the likelihood of multiple image / ser files being generated with the same time stamp, SharpCap filename for your selected output time should include an additional quailifier to make the output more unique. I'm using {Exposure} in the filename to accomplish this.</li>
                <li>Ahead of the eclipse, please test the operation and behavior of your hardware.  Specifically, that the frame download and saving rate can keep up with the collection plan.  Otherwise, unexpected behavior may occur durint the eclipse.</li>
            </ul>
        </div>
        <a id="tipsToggle" href="javascript://" onClick="toggleDiv('tips');" style="margin: 15px;">( Show Tips )</a>
        <div id="tipsDiv">
            <b>Tips:</b>
            <ul style="margin-top: 3px;">
                <li>If you'd like to get a head start to tweak your action plan in the future, copy the URL - the top parameters are encoded there and will be re-populated if you use it in the future.</li>
                <li>The parameter encoded URL is put as a comment in the top of the generated sequence file, so you can use that for future collection plan tweaks.</li>
                <li>If you'd like to capture the Baily's Beads Collection Plan into totality, you can do so by fudging the 'Full Begins' and/or 'Full Ends' times to be after totality begins/before totality ends.</li>
            </ul>
        </div>
        <a id="instructionsToggle" href="javascript://" onClick="toggleDiv('instructions');" style="margin: 15px;">( Show Instructions )</a>
        <div id="instructionsDiv">
            <b>Instructions:</b>
            <ol style="margin-top: 3px;">
                <li>Go to <a href="https://www.timeanddate.com/eclipse/map/2024-april-8" target="_blank">Eclipse Map</a>.</li>
                <li>Zoom into your observation location and click to place the pin on the map.</li>
                <li>Note the Partial and Full Begin and End times provided on the left side of the map.</li>
                <li>Enter the observing site local times under <i>Eclipse Times</i> below, in 24 hour, HH:MM:SS format.</li>
                <li>Adjust the <i>Intervals</i> and <i>Cmera Settings</i> as desired below.<br />
                    <b>Notes:</b><br />
                    <i>Partial Eclipse Count</i> generates evenly spaced shots based on partial eclipse percentage, starting 2 minutes into the eclipse. <b>(recommended)</b><br />
                    <i>Partial Eclipse Interval</i> generates evenly space shots based on time.<br />
                    <i>The two cannot be used at the same time.</i>
                </li>
                <li>Add and adjust the steps for each <i>Collection Plan</i> section below.</li>
                <li>Click the <i>Generate</i> button.</li>
                <li>A <i>Generated Sequence</i> section will appear below.</li>
                <li>Use the <i>Download SharpCap Sequence</i> button and save the sequence file.</li>
                <li>In SharpCap, connect to your camera and center the Sun in your camera's view.</li>
                <li>In SharpCap, click the <i>Sequencer</i> menu item, then <i>Run...</i></li>
                <li>Pick the downloaded sequence file and click the <i>Open</i> button.</li>
                <li>Monitor for an Alert sound, and banner at the top to Remove or Apply the Solar Filter around the time of Totality.</li>
            </ol>
        </div>
        <table id="wrapperTable"><tr style="vertical-align: top;"><td>
            <table class="params">
                <tr><th colspan="2" class="headerBlock">Eclipse Times</th></tr>

                <tr><td class="label">Partial Begins:</td><td><input onChange="verifyTime(this);" onKeyUp="verifyTime(this);" id="partial_begins" type="text"></td></tr>
                <tr><td class="label">Full Begins:</td><td><input onChange="verifyTime(this);" onKeyUp="verifyTime(this);" id='full_begins' type="text"></td></tr>
                <tr><td class="label">Full Ends:</td><td><input onChange="verifyTime(this);" onKeyUp="verifyTime(this);" id='full_ends' type="text"></td></tr>
                <tr><td class="label">Partial Ends:</td><td><input onChange="verifyTime(this);" onKeyUp="verifyTime(this);" id="partial_ends" type="text"></td></tr>
            </table></td><td>
                <table class="params" id="phaseInterval">
                    <th colspan="2" class="headerBlock">Interval</th>
                    <tr><td class="label">Partial Eclipse Count:</td><td>
                        <select id='partialCount' onChange="checkVisible('partialCount');">
                            <option value="0">Disabled</option>
                            <option value="5">5 times</option>
                            <option value="10" selected="selected">10 times</option>
                            <option value="20">20 times</option>
                            <option value="40">40 times</option>
                            <option value="50">50 times</option>
                            <option value="100">100 times</option>
                        </select> before and after
                    </td></tr>
                    <tr><td class="label">Partial Eclipse Interval:</td><td>
                        <select id='partialInterval' onChange="checkVisible('partialInterval');">
                            <option value="0">Disabled</option>
                            <option value="30">every 30 seconds</option>
                            <option value="60">every 1 minute</option>
                            <option value="120">every 2 minutes</option>
                            <option value="180">every 3 minutes</option>
                            <option value="240">every 4 minutes</option>
                            <option value="300">every 5 minutes</option>
                            <option value="360">every 6 minutes</option>
                            <option value="420">every 7 minutes</option>
                            <option value="480">every 8 minutes</option>
                            <option value="540">every 9 minutes</option>
                            <option value="600">every 10 minute</option>
                        </select>
                    </td></tr>
                    <tr><td class="label">Baily's Beads Capture Offset:</td><td>
                        <select id='bailysInterval' onChange="checkVisible('bailysInterval');">
                            <option value="0">Disabled</option>
                            <option value="6">+/- 6 seconds</option>
                            <option value="8" selected="selected">+/- 8 seconds</option>
                            <option value="10">+/- 10 seconds</option>
                            <option value="20">+/- 20 seconds</option>
                            <option value="30">+/- 30 seconds</option>
                            <option value="45">+/- 45 seconds</option>
                            <option value="60">+/- 60 seconds</option>
                        </select>
                    </td></tr>
                    <tr><td class="label">Totality Interval:</td><td>at most, every 1 second<input type='hidden' id='totalityInterval' value='1'/></td></tr>
                </table>
            </td><td>
            <table class="params">
                <th colspan="2" class="headerBlock">Camera Settings</th>
                <tr><td class="label">Camera Gain:</td><td><input onChange="hideOutput();" type="number" id="gain" value="26" min="0"/></td></tr>
                <tr><td class="label">Camera Offset:</td><td><input onChange="hideOutput();" type="number" id="offset" value="70" min="0"/></td></tr>
                <tr><td class="label">Output Format:</td><td>
                    <select id="output" onChange="hideOutput();">
                        <option value="SER file (*.ser)">SER</option>
                        <option value="PNG files (*.png)">PNG</option>
                        <option value="FITS files (*.fits)">FITS</option>
                        <option value="TIFF files (*.tif)">TIFF</option>
                        <option value="ADV files (*.adv)">ADV</option>
                    </select></td></tr>
            </table>
        </th></tr></table>
        <div class="planDiv" id="partialPlanDiv"><h3 class="headerBlock">Partial Phase Collection Plan :: repeat <span id="partialPlanHeader"></span></h3><b>NOTE:</b> The collection plan should take less than <span id="partialIntervalHTML">30 seconds</span> with your camera.<table class="planTable" id="partialPlan"></table><input type='button' class="wideButton" value="Add Partial Plan Row" onClick='addPlanLine("partialPlan")' /></div>
        <div class="planDiv" id="bailysPlanDiv"><h3 class="headerBlock">Baily's Beads Collection Plan :: repeat every second for <span id="bailysPlanHeader"></span></h3><b>NOTE:</b> The collection plan should take less than 1 second with your camera.<table class="planTable" id="bailysPlan"></table><input type='button' class="wideButton" value="Add Bailys Plan Row" onClick='addPlanLine("bailysPlan")' /></div>
        <div class="planDiv" id="totalityPlanDiv"><h3 class="headerBlock">Totality Collection Plan :: At most, every 1 second</h3><table class="planTable" id="totalityPlan"></table><input type='button' class="wideButton" value="Add Totality Plan Row" onClick='addPlanLine("totalityPlan")' /></div>
        <input type="button" style="max-width: 45%; margin: 30px auto; padding: 30px;" value="Generate Sequence" id="generateButton" onClick="generateSharpCap();"/>

        <div class="planDiv" id="sequenceDiv" style="display: none;">
            <h3 class="headerBlock">Generated Sequence</h3>
            <input type="button" value="Copy Sequence to Clipboard" id="clipboardButton" style="margin: 15px 15px 0 15px; max-width: 45%;" onClick="copyToClipboard();" /><input type="button" value="Download SharpCap Sequence" id="downloadButton" style="max-width: 45%;" onClick="downloadSequence();" />
            <textarea id="SharpCapSequence" style="width: 98%; height: 200px;" readonly="readonly"
            placeholder="SharpCap sequence will appear here."></textarea>
        </div>
    </div>
    <script type="text/javascript">
        function uuidv4() {
            return "10000000-1000-4000-8000-100000000000".replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }

        function ucFirst(word) {
            return word.charAt(0).toUpperCase() + word.slice(1);
        }

        function toggleDiv(t) {
            let i = document.getElementById(t+'Div');
            let a = document.getElementById(t+'Toggle');
            if(a.innerHTML == "( Hide "+ucFirst(t)+" )" ) {
                i.style.display = "none";
                a.innerHTML = "( Show "+ucFirst(t)+" )";
            } else {
                i.style.display = "block";
                a.innerHTML = "( Hide "+ucFirst(t)+" )";
            }
            updateURL();
        }

        function checkVisible(t) {
            let pmap = { "partialCount": "partialInterval", "partialInterval": "partialCount" };
            let e = document.getElementById(t);
            t = t.replace(/[A-Z].*$/,"");
            try {
                if(e.value==0) {
                    if(t.match("partial")) {
                        let pi=document.getElementById("partialInterval").value;
                        let pc=document.getElementById("partialCount").value;
                        if(pi==0 && pc==0) {
                            document.getElementById(t+"PlanDiv").style.display="none";
                            document.getElementById("partial_begins").classList.remove("goodInput");
                            document.getElementById("partial_begins").classList.remove("badInput");
                            document.getElementById("partial_begins").classList.add("disabledInput");
                            document.getElementById("partial_begins").readonly="readonly";
                            document.getElementById("partial_ends").classList.remove("goodInput");
                            document.getElementById("partial_ends").classList.remove("badInput");
                            document.getElementById("partial_ends").classList.add("disabledInput");
                            document.getElementById("partial_ends").readonly="readonly";
                        } else {
                            document.getElementById(t+"PlanDiv").style.display="block";
                            var phPost = "";
                            if(pc>0)
                                phPost = " before and after totality";
                            document.getElementById(t+"PlanHeader").innerHTML = e.options[e.selectedIndex].innerHTML + phPost;
                            document.getElementById("partialIntervalHTML").innerHTML = document.getElementById("partialInterval").options[document.getElementById("partialInterval").selectedIndex].innerHTML.replace("every ","");
                            if(document.getElementById(t+"Plan").rows.length==0)
                                addPlanLine(t+"Plan");
                            document.getElementById("partial_begins").removeAttribute('readonly');
                            document.getElementById("partial_ends").removeAttribute('readonly');
                            verifyTime(document.getElementById("partial_begins"));
                            verifyTime(document.getElementById("partial_ends"));
                        }
                    } else {
                        document.getElementById(t+"PlanDiv").style.display="none";
                    }
                } else {
                    var phPost = "";
                    if(t.match("partial")) {
                        document.getElementById(pmap[e.id]).value = 0;
                        if(document.getElementById("partialCount").value>0)
                            phPost = " before and after totality";
                    }
                    document.getElementById(t+"PlanDiv").style.display="block";
                    document.getElementById(t+"PlanHeader").innerHTML = e.options[e.selectedIndex].innerHTML + phPost;
                    document.getElementById("partialIntervalHTML").innerHTML = document.getElementById("partialInterval").options[document.getElementById("partialInterval").selectedIndex].innerHTML.replace("every ","");
                    if(document.getElementById(t+"Plan").rows.length==0)
                        addPlanLine(t+"Plan");
                    if(t=="partial") {
                        document.getElementById("partial_begins").removeAttribute('readonly');
                        document.getElementById("partial_ends").removeAttribute('readonly');
                        verifyTime(document.getElementById("partial_begins"));
                        verifyTime(document.getElementById("partial_ends"));
                    }
                }
            } catch(err) {
                console.log("Err: "+t);
            }
            hideOutput();
        }

        function hideOutput() {
            document.getElementById("sequenceDiv").style.display = "none";
            updateURL();
        }

        function verifyTime(t) {
            hideOutput();
            let v=/^([0-1]?[0-9]|2[0-3]):([0-5][0-9])(:[0-5][0-9])$/.test(t.value);
            if(v) {
                t.classList.add("goodInput");
                t.classList.remove("badInput");
                t.classList.remove("disabledInput");
                updateURL();
            } else {
                t.classList.remove("goodInput");
                t.classList.add("badInput");
                t.classList.remove("disabledInput");
            }
        }

        function checkIfLastStep(t) {
            let tbl = document.getElementById(t);
            if(tbl.rows.length==1)
                tbl.rows[0].cells[4].style.display="none";
            else
                tbl.rows[0].cells[4].style.display="block";
                hideOutput();
        }

        function addPlanLine(t) {
            let rowID = uuidv4();
            let tbl = document.getElementById(t);
            let rows = tbl.rows.length;
            let row = tbl.insertRow(tbl.rows.length);
            var cells = [];
            for(var i=0; i<5; i++)
                cells.push(row.insertCell(i));
            cells[0].innerHTML = "<input type='hidden' name='uuid' value='"+rowID+"' /><span name='step'>Step "+(rows+1).toString()+"</span>";
            cells[0].style.fontWeight = "bold";
            cells[0].style.textAlign = "center";
            cells[1].innerHTML = "Capture <input type='number' id='"+rowID+"count' value='1' min='1' /><select id='"+rowID+"type'><option value='frames' selected='selected'>frames</option><option value='seconds'>seconds</option></select>";
            cells[2].innerHTML = "at Exposure: <input type='number' id='"+rowID+"exposure' value='0.01' min='0' /> sec";
            cells[3].innerHTML = "at Resolution: <input type='text' id='"+rowID+"resolution' value='' /> pixels (blank = no change)";
            cells[4].innerHTML = "<input type='button' value='Delete Step' onClick='removeRow(this)' />"
            checkIfLastStep(t);
        }

        function removeRow(t) {
            let p = t.parentNode.parentNode;
            let tbl = document.getElementById(p.parentNode.parentNode.id);
            if(tbl.rows.length==1) {
                alert("Collection Plan needs at least one step.  Cannot delete the last step.");
                return;
            }
            p.parentNode.removeChild(p);

            for(var i=0;i<tbl.rows.length;i++) {
                tbl.rows[0].cells[0].childNodes[1].innerHTML = "Step "+(i+1).toString();
            }
            checkIfLastStep(tbl.id);
        }

        function format02d(v) {
            return(("00"+v.toString()).substr(-2))
        }

        function timeToSeconds(tm) {
            let tp = tm.split(":");
            var secs = parseInt(tp[2]);
            secs += parseInt(tp[1])*60;
            secs += parseInt(tp[0])*3600;
            return secs;
        }

        function secondsToTime(secs) {
            let h = Math.floor(secs/3600);
            secs -= h*3600;
            let m = Math.floor(secs/60);
            secs -= m*60;
            return(format02d(h)+":"+format02d(m)+":"+format02d(secs))
        }

        function generateSharpCap() {
            var output = new Array("# Generated at: ","# "+window.location.href, "SEQUENCE");
            var indent = 4;
            let partialInterval = parseInt(document.getElementById("partialInterval").value);
            let partialCount = parseInt(document.getElementById("partialCount").value);
            let bailysInterval = parseInt(document.getElementById("bailysInterval").value);
            let totalityDuration = timeToSeconds(document.getElementById("full_ends").value) - timeToSeconds(document.getElementById("full_begins").value);
            var preInterval = partialInterval;
            var postInterval = partialInterval;
            if(partialCount>0) {
                let preDuration = timeToSeconds(document.getElementById("full_begins").value) - timeToSeconds(document.getElementById("partial_begins").value) - bailysInterval - 120;
                let postDuration = timeToSeconds(document.getElementById("partial_ends").value) - timeToSeconds(document.getElementById("full_ends").value) - bailysInterval - 120;
                preInterval = preDuration / partialCount;
                postInterval = postDuration / partialCount;
            }

            try {
                if(partialInterval>0 || partialCount>0) {
                    ["partial_begins", "partial_ends"].forEach((t) => {
                        let v = /^([0-1]?[0-9]|2[0-3]):([0-5][0-9])(:[0-5][0-9])$/.test(document.getElementById(t).value);
                        if(document.getElementById(t).value=="" || !v) {
                            alert("  Sorry, please fill in the "+t.split("_").join(" ")+" timestamp\n    in 24 hour, HH:MM:SS format.");
                            throw BreakException;
                        }
                    });
                }
                ["full_begins", "full_ends"].forEach((t) => {
                    let v = /^([0-1]?[0-9]|2[0-3]):([0-5][0-9])(:[0-5][0-9])$/.test(document.getElementById(t).value);
                    if(document.getElementById(t).value=="" || !v) {
                        alert("  Sorry, please fill in the "+t.split("_").join(" ")+" timestamp\n    in 24 hour, HH:MM:SS format.");
                        throw BreakException;
                    }
                });
            } catch(e) {
                return;
            }

            ["partialInterval", "partialCount", "bailysInterval", "totalityInterval"].forEach((p) => {
                let e = document.getElementById(p);
                if(e.value!=0) {
                    p = p.replace(/[A-Z].*$/,"");
                    output.push(' '.repeat(indent)+"DEF SUB "+p+"Collection");
                    indent+=4;
                    let t = document.getElementById(p+"Plan");
                    var lastRes = "";
                    for( var row=0; row<t.rows.length; row++ ) {
                        let rowID = t.rows[row].cells[0].childNodes[0].value;
                        output.push(' '.repeat(indent)+"SET EXPOSURE TO "+document.getElementById(rowID+"exposure").value);
                        if(document.getElementById(rowID+"resolution").value!="" && document.getElementById(rowID+"resolution").value!=lastRes)
                            output.push(' '.repeat(indent)+"SET RESOLUTION TO "+document.getElementById(rowID+"resolution").value);
                        var secVerb = "";
                        if(document.getElementById(rowID+"type").value=="seconds")
                            secVerb = " SECONDS ";
                        if(row>0) {
                            var delaySecs = Math.min(document.getElementById(rowID+"exposure").value * 5,2);
                            output.push(' '.repeat(indent)+"DELAY "+delaySecs.toString());
                        }
                        output.push(' '.repeat(indent)+"CAPTURE "+document.getElementById(rowID+"count").value+secVerb+" LIVE FRAMES");
                        lastRes=document.getElementById(rowID+"resolution").value;
                    }
                    indent-=4;
                    output.push(' '.repeat(indent)+"END SUB")
                    output.push("");
                }
            });

            function addWaitSub(title,startTime,offsetTime) {
                output.push(' '.repeat(indent)+"DEF SUB waitFor"+title)
                indent+=4;
                let st = secondsToTime(timeToSeconds(startTime)+offsetTime);
                output.push(' '.repeat(indent)+"WAIT UNTIL LATER THAN LOCALTIME "+st);
                indent-=4;
                output.push(' '.repeat(indent)+"END SUB")
                output.push("");
            }

            var esOffset=0;
            if(partialInterval>0 || partialCount>0 ) {
                addWaitSub('PreEclipseStart',document.getElementById('partial_begins').value,-60);
                if(partialCount > 0)
                    esOffset=120;
                addWaitSub('EclipseStart',document.getElementById('partial_begins').value,esOffset);
            }
            if(bailysInterval>0) {
                addWaitSub('BailysOneStart',document.getElementById('full_begins').value,bailysInterval*-1);
            }
            addWaitSub('TotalityStart',document.getElementById('full_begins').value,0);

            if(bailysInterval>0) {
                addWaitSub('BailysTwoEnd',document.getElementById('full_ends').value,bailysInterval);
            }
            if(partialInterval>0 || partialCount>0) {
                if(partialCount > 0)
                    esOffset=-120;
                addWaitSub('EclipseEnd',document.getElementById('partial_ends').value,esOffset);
                addWaitSub('PostEclipseEnd',document.getElementById('partial_ends').value,60);
            }

            output.push("SEQUENCE");
            output.push(`    PRESERVE CAMERA SETTINGS`);
            output.push(`        UNLOCK CONTROLS`);
            output.push("");
            indent=12;

            output.push(' '.repeat(indent)+"LIVE MODE");
            output.push(' '.repeat(indent)+'ARRANGE FILES IN ONE FOLDER');
            output.push(' '.repeat(indent)+'TARGETNAME "PartialPreEclipse"');
            output.push(' '.repeat(indent)+"SET GAIN TO "+document.getElementById("gain").value);
            output.push(' '.repeat(indent)+"SET OFFSET to "+document.getElementById("offset").value);
            output.push(' '.repeat(indent)+'SET OUTPUT FORMAT TO "'+document.getElementById("output").value+'"');
            output.push("");

            if(partialInterval>0 || partialCount>0) {
                output.push(' '.repeat(indent)+"GOSUB waitForPreEclipseStart");
                output.push(' '.repeat(indent)+"GOSUB partialCollection");
                output.push("")
                output.push(' '.repeat(indent)+"GOSUB waitForEclipseStart");
                var st = secondsToTime(timeToSeconds(document.getElementById('full_begins').value)-bailysInterval);
                output.push(' '.repeat(indent)+"LOOP UNTIL LATER THAN LOCALTIME "+st);
                indent+=4;
                output.push(' '.repeat(indent)+"PAD DURATION TO "+preInterval.toString());
                indent+=4;
                output.push(' '.repeat(indent)+"GOSUB partialCollection");
                indent-=4;
                output.push(' '.repeat(indent)+"END PAD DURATION");
                indent-=4;
                output.push(' '.repeat(indent)+"END LOOP");
                output.push("");
            }
            if(bailysInterval>0) {
                output.push(' '.repeat(indent)+'TARGETNAME "BailysBeadsPreEclipse"');
                output.push(' '.repeat(indent)+"PLAY SOUND Alert");
                output.push(' '.repeat(indent)+'SHOW NOTIFICATION "Remove the Solar Filter!" COLOUR Green DURATION '+(totalityDuration+bailysInterval).toString());

                output.push(' '.repeat(indent)+"LOOP UNTIL LATER THAN LOCALTIME "+document.getElementById('full_begins').value);
                indent+=4;
                output.push(' '.repeat(indent)+"PAD DURATION TO 1");
                indent+=4;
                output.push(' '.repeat(indent)+"GOSUB bailysCollection");
                indent-=4;
                output.push(' '.repeat(indent)+"END PAD DURATION");
                indent-=4;
                output.push(' '.repeat(indent)+"END LOOP");
                output.push("");
            }
            if(partialInterval==0 && partialCount==0 && bailysInterval==0) {
                output.push(' '.repeat(indent)+"GOSUB waitForTotalityStart");
                output.push(' '.repeat(indent)+"PLAY SOUND Alert");
                output.push(' '.repeat(indent)+'SHOW NOTIFICATION "Remove the Solar Filter!" COLOUR Green DURATION '+totalityDuration.toString());
            }
            output.push(' '.repeat(indent)+'TARGETNAME "FullEclipse"');
            output.push(' '.repeat(indent)+"LOOP UNTIL LOCALTIME "+document.getElementById("full_ends").value);
            indent+=4;
            output.push(' '.repeat(indent)+"PAD DURATION TO 1");
            indent+=4;
            output.push(' '.repeat(indent)+"GOSUB totalityCollection");
            indent-=4;
            output.push(' '.repeat(indent)+"END PAD DURATION");
            indent-=4;
            output.push(' '.repeat(indent)+"END LOOP");
            output.push("");

            if(bailysInterval>0) {
                output.push(' '.repeat(indent)+'TARGETNAME "BailysBeadsPostEclipse"');
                var st = secondsToTime(timeToSeconds(document.getElementById('full_ends').value)+bailysInterval);
                output.push(' '.repeat(indent)+"LOOP UNTIL LATER THAN LOCALTIME "+st);
                indent+=4;
                output.push(' '.repeat(indent)+"PAD DURATION TO 1");
                indent+=4;
                output.push(' '.repeat(indent)+"GOSUB bailysCollection");
                indent-=4;
                output.push(' '.repeat(indent)+"END PAD DURATION");
                indent-=4;
                output.push(' '.repeat(indent)+"END LOOP");
                output.push("");
            }
            output.push(' '.repeat(indent)+"PLAY SOUND Error");
            output.push(' '.repeat(indent)+'SHOW NOTIFICATION "URGENT!   Apply the Solar Filter!   URGNET!" COLOUR Red DURATION 120');
            output.push("");

            if(partialInterval>0 || partialCount>0) {
                output.push(' '.repeat(indent)+'TARGETNAME "PartialPostEclipse"');
                output.push(' '.repeat(indent)+"LOOP UNTIL LATER THAN LOCALTIME "+document.getElementById('partial_ends').value);
                indent+=4;
                output.push(' '.repeat(indent)+"PAD DURATION TO "+postInterval.toString());
                indent+=4;
                output.push(' '.repeat(indent)+"GOSUB partialCollection");
                indent-=4;
                output.push(' '.repeat(indent)+"END PAD DURATION");
                indent-=4;
                output.push(' '.repeat(indent)+"END LOOP");
                output.push("");

                output.push(' '.repeat(indent)+"GOSUB waitForPostEclipseEnd");
                output.push(' '.repeat(indent)+"GOSUB partialCollection");
                output.push("");


            }
            output.push(' '.repeat(indent)+"PLAY SOUND Alert");
            output.push(' '.repeat(indent)+'SHOW NOTIFICATION "Solar Eclipse Collection is complete!" COLOUR Green DURATION 120');

            output.push(`        END UNLOCK`);
            output.push(`    END PRESERVE`);
            output.push("END SEQUENCE");
            document.getElementById("SharpCapSequence").value = output.join("\n");
            document.getElementById("sequenceDiv").style.display = "block";
            window.scrollTo(0, document.body.scrollHeight);
        }

        function copyToClipboard() {
            navigator.clipboard.writeText(document.getElementById("SharpCapSequence").value);
        }

        function downloadSequence() {
            var textToSave = document.getElementById("SharpCapSequence").value;
            var textToSaveAsBlob = new Blob([textToSave], {type:"text/plain"});
            var textToSaveAsURL = window.URL.createObjectURL(textToSaveAsBlob);
            var fileNameToSaveAs = "SharpCap_Eclipse_Sequence.scs";

            var downloadLink = document.createElement("a");
            downloadLink.download = fileNameToSaveAs;
            downloadLink.innerHTML = "Download File";
            downloadLink.href = textToSaveAsURL;
            downloadLink.onclick = destroyClickedElement;
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);

            downloadLink.click();
        }

        function destroyClickedElement(event) {
            document.body.removeChild(event.target);
        }

        function readURL() {
            let kvs = window.location.hash.replace("#","").split(";");
            kvs.forEach((a) => {
                let kv=decodeURI(a).split("=");
                try {
                    document.getElementById(kv[0]).value = kv[1];
                } catch(e) {
                    // pass;
                }
            });
        }

        function updateURL() {
            var params = [];
            ["partial_begins", "partial_ends","full_begins", "full_ends","bailysInterval","partialInterval", "partialCount","gain","offset","output"].forEach((a) => {
                params.push(a+"="+document.getElementById(a).value);
            });
            window.location.hash=params.join(";");
        }
        readURL();
        checkVisible("partialInterval");
        checkVisible("partialCount");
        checkVisible("bailysInterval");
        addPlanLine("totalityPlan");
        ["partial_begins","full_begins","full_ends","partial_ends"].forEach((t) => verifyTime(document.getElementById(t)));
    </script>
</body>
 
</html>